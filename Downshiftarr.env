# Downshiftarr configuration
#
# How to use:
#   1) Put this file next to the script as: Downshiftarr.env
#   2) Protect it (recommended): chmod 600 Downshiftarr.env
#
# Notes:
# - Values are read from this file via python-dotenv (if installed), otherwise from OS environment variables.
# - Blank values usually mean "use the built-in default" (see README.md).
# - Anything that contains spaces (like messages) should be kept on one line.

# ---------------------------------------------------------------------
# Required: Plex + Tautulli endpoints + credentials
# ---------------------------------------------------------------------

# Plex Media Server base URL (must be reachable from where Tautulli runs)
# Examples:
#   http://127.0.0.1:32400
#   http://192.168.1.10:32400
#   http://host.docker.internal:32400   (Docker Desktop)
PLEX_URL=http://127.0.0.1:32400

# Plex token (admin token should always be used)
PLEX_TOKEN=PUT_YOUR_PLEX_TOKEN_HERE

# Optional fallback token (if you don't want to use an admin token)
# (Downshiftarr will try PLEX_TOKEN first, then PLEX_USER_TOKEN)
PLEX_USER_TOKEN=

# Tautulli base URL + API key (must be reachable from where the script runs)
# Example: http://127.0.0.1:8181
TAUTULLI_URL=http://127.0.0.1:8181
TAUTULLI_APIKEY=PUT_YOUR_TAUTULLI_API_KEY_HERE

# Network timeout (seconds) for HTTP calls to Plex/Tautulli
HTTP_TIMEOUT_S=8

# ---------------------------------------------------------------------
# Logging
# ---------------------------------------------------------------------

# Where Downshiftarr writes its rotating log file
# Tip: if Tautulli runs in Docker, make sure this path is inside a mounted volume.
LOG_FILE=/tmp/downshiftarr.log

# Logging verbosity:
#   INFO  = normal operation
#   DEBUG = extremely chatty (recommended while tuning)
LOG_LEVEL=INFO

# If VERBOSE=1, Downshiftarr forces DEBUG regardless of LOG_LEVEL.
VERBOSE=0

# Write logs to stderr as well (Tautulli captures this output)
LOG_TO_STDERR=1

# Log rotation
LOG_MAX_BYTES=2000000
LOG_BACKUP_COUNT=5

# ---------------------------------------------------------------------
# Optional: "log into Tautulli" via a Tautulli Notification entry (notify API)
# ---------------------------------------------------------------------
# This does NOT write into Tautulli's main application log. Instead, it creates
# notification entries (and sends via the chosen notifier).
#
# IMPORTANT: Choose a notifier that does NOT run this script, or you'll create a loop.
#
# To enable, set the notifier ID (integer). Leave blank to disable.
TAUTULLI_LOG_NOTIFIER_ID=

# Only send Tautulli notifications at or above this level:
#   DEBUG, INFO, WARNING, ERROR, CRITICAL
TAUTULLI_LOG_MIN_LEVEL=WARNING

# Subject/title used for those notify entries
TAUTULLI_LOG_SUBJECT=Downshiftarr

# ---------------------------------------------------------------------
# Policy: what counts as "protected" and how fallbacks are picked
# ---------------------------------------------------------------------

# Comma-separated Plex usernames that are exempt from enforcement
# Example: EXEMPT_USERS=AdminUser,HomeOwner
EXEMPT_USERS=

# Height threshold: media with height >= this is treated as "4K-ish"
# 2000 is used so 2160p falls into the protected set.
MAX_ALLOWED_HEIGHT=2000

# Preferred fallback heights (in order).
# Downshiftarr will try to pick the "best" match from the versions you have:
# e.g. 1080 first, then 720, etc.
PREFER_HEIGHTS=1080,720,576,480

# Fallback selection rules:
# - FALLBACK_SDR_ONLY=1  => ONLY switch to SDR versions (default, strict)
# - FALLBACK_SDR_ONLY=0  => allow HDR/DV fallbacks depending on ALLOW_HDR_FALLBACK
FALLBACK_SDR_ONLY=1

# If FALLBACK_SDR_ONLY=0 and ALLOW_HDR_FALLBACK=1:
# - Prefer SDR versions, but if none exist, allow HDR/DV fallbacks under MAX_ALLOWED_HEIGHT.
ALLOW_HDR_FALLBACK=0

# ---------------------------------------------------------------------
# Speed / retry tuning (keep these low for snappy enforcement)
# ---------------------------------------------------------------------

# Plex session lookup retries + delay (useful because Playback Start may fire before the session fully appears)
SESSION_LOOKUP_RETRIES=4
SESSION_LOOKUP_DELAY_S=0.25

# After downshift, some clients ignore the initial offset. Downshiftarr will seek.
SEEK_DELAY_S=0.75
SEEK_RETRIES=3
SEEK_RETRY_DELAY_S=0.50

# ---------------------------------------------------------------------
# Enforcement toggles (fail-closed defaults)
# ---------------------------------------------------------------------
# Each toggle controls whether Downshiftarr terminates the stream when that failure occurs.
# Use 0 to disable termination for a specific scenario.

KILL_ON_PLEX_CONNECT_FAIL=1
KILL_ON_SESSION_NOT_FOUND=1
KILL_ON_CLIENT_NOT_FOUND=1
KILL_ON_NO_FALLBACK_MEDIA=1
KILL_ON_SWITCH_FAIL=1
KILL_ON_UNEXPECTED_ERROR=1

# ---------------------------------------------------------------------
# Kill messages (optional)
# ---------------------------------------------------------------------
# If you leave these blank, Downshiftarr uses KILL_MESSAGE_DEFAULT.

KILL_MESSAGE_DEFAULT=This 4K/HDR title cannot be transcoded. Please select the 1080p (or lower) version from the 3 dot menu.

KILL_MESSAGE_PLEX_CONNECT_FAIL=
KILL_MESSAGE_SESSION_NOT_FOUND=
KILL_MESSAGE_CLIENT_NOT_FOUND=
KILL_MESSAGE_NO_FALLBACK_MEDIA=
KILL_MESSAGE_SWITCH_FAIL=
KILL_MESSAGE_UNEXPECTED_ERROR=

# ---------------------------------------------------------------------
# Advanced: override env file location
# ---------------------------------------------------------------------
# If you want to store the config somewhere else, set ENV_FILE in the environment
# (NOT here), because this file is the thing being loaded.
#
# Example (systemd / docker / shell):
#   ENV_FILE=/etc/downshiftarr/Downshiftarr.env
